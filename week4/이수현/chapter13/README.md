# Chapter13 - 교착상태 (DeadLock)
## 13-1 교착상태란
### 배경: 식사하는 철학자 문제
#### 상황
  + **철학자** 5명이 파스타 5개와 **포크** 5개가 놓여져 있는 테이블에 앉아있음
#### 식사 규칙
  + 계속 생각을 하다가 왼쪽 포크가 사용 가능하면 집어든다.
  + 계속 생각을 하다가 오른쪽 포크가 사용 가능하면 집어든다.
  + 왼쪽과 오른쪽 포크를 모두 집어들어야지만 정해진 시간동안 식사 가능하다.
  + 식사가 끝나면 오른쪽 포크를 내려놓는다.
  + 오른쪽 포크를 내려놓은 뒤 왼쪽 포크를 내려놓는다. 
#### 문제
  + 모든 철학자들이 서로 포크를 내려놓을 때까지 기다리게 됨 -> 교착상태!
### 교착 상태란?
<img width="521" height="226" alt="Image" src="https://github.com/user-attachments/assets/2014c61c-1a28-4b11-83ed-f9de0a8e9a99" />

+ 일어나지 않을 사건을 기다리며 진행이 멈춰버리는 현상
+ 각 프로세스가 서로가 필요로하는 자원을 가지고 있는 상황

### 교착상태 발생 상황 표현 방법: 자원 할당 그래프
+ 교착 상태 발생 조건을 파악할 수 있는 그래프
  + 어떤 프로세스가 어떤 자원을 할당 받아 사용중인지 확인 가능
  + 어떤 프로세스가 어떤 자원을 기다리고 있는지 확인 가능
#### How to Draw?
  <img width="525" height="266" alt="Image" src="https://github.com/user-attachments/assets/442c9ce5-9e17-498b-9906-33410c6a8076" />
  
  + **프로세스는 원**으로, **자원의 종류는 사각형**으로 표현
  + 사용할 수 있는 **자원의 개수**는 자원 사격형 내에 **점**으로 표현
  + 특정 프로세스가 특정 자원을 **사용중이라면, 자원 -> 프로세스로 화살표** 표시
  + 특정 프로세스가 어떤 자원을 **기다리고 있다면, 프로세스 -> 자원으로 화살표** 표시
#### 교착상태가 발생한 그래프
<img width="395" height="212" alt="Image" src="https://github.com/user-attachments/assets/a0ea34c2-550e-43d4-b0f3-c0d1c1c1301b" />

+ 자원 할당 그래프가 **사이클**을 형성하면 교착상태 발생!
### 교착상태 발생 조건
> 다음 4가지 조건을 모두 만족하면 교착 상태 발생 가능
> 
> 다음 4가지 중 하나라도 불만족 시, 교착 상태 발생 X
#### 1. 상호배제
+ 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없는 상태
#### 2. 점유와 대기
+ 자원을 할당 받은 상태에서 다른 자원을 할당 받기를 기다리는 상태
#### 3. 비선점
+ 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못하는 상태
#### 4. 원형 대기
+ 프로세스들이 원의 형태로 자원을 대기하는 상태

---
## 13-2 교착상태 해결방법
### 1. 교착 상태 예방
> 교착 상태가 발생하지 않음은 보장할 수 있으나, 부작용이 따르는 방식임
+ 애초에 교착 상태가 발생하지 않도록 하는 법
+ 즉, 교착 상태 발생 조건 4가지 중 하나를 없애버린다.
#### 만약 상호배제는 없앤다면?
<img width="349" height="204" alt="Image" src="https://github.com/user-attachments/assets/c31df0d1-1ca0-43d0-aba9-7db67dc06468" />

+ 모든 자원을 공유 가능하게 만든다..?
+ 단점: 현실적으로 불가능!
+ 예) 프린터기가 하나의 종이에 여러 작업을 동시에 표현할 이유가 없다.

#### 만약 점유와 대기를 없앤다면?
+ 특정 프로세스에 자원을 모두 할당하거나, 아예 할당하지 않는 방식으로 배분하는 방법
+ 단점: 자원의 활용률을 낮출 수 있으므로 적합하지 않음

#### 만약 비선점 조건을 없앤다면?
+ 선점이 가능한 자원(CPU..)에 한해 효과적
+ 단점: 모든 자원이 선점 가능한 것이 아니므로 적합하지 않음

#### 만약 원형 대기 조건을 없앤다면?
<img width="339" height="273" alt="Image" src="https://github.com/user-attachments/assets/906f781c-272b-44cd-8020-0c16f7e42072" />

+ 예) 자원에 번호를 붙이고 오름차순으로 할당하면, 원형 대기는 발생하지 않음
+ 한계 
  + 자원에 번호를 붙이는 것은 어려운 작업
  + 어떤 자원에 어떤 번호를 붙이느냐에 따라 활용률이 달라짐 
### 2. 회피
<img width="634" height="246" alt="Image" src="https://github.com/user-attachments/assets/9c92a840-b17a-4138-bd33-4a384b85a327" />

+ 교착 상태를 무분별한 자원 할당으로 인해 발생했다고 간주함
+ 교착 상태가 발생하지 않을 만큼 조심하여 할당하는 방식
+ 즉, 배분할 수 있는 자원의 양을 고려하여 교착 상태가 발생하지 않도록 함
#### 개념 정리
+ 안전 순서열: 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서
+ 안전 상태: 교착 상태 없이 모든 프로세스가 자원을 할당받고 종료될 수 있는 상태 (안전 순서열 O)
+ 불안전 상태: 교착 상태가 발생할 수도 있는 상태 (안전 순서열 X)
> 항상 안전 상태를 유지하도록 자원을 할당하는 방식
#### 은행원 알고리즘
+ 상황
  + 은행에서 여러 사업가에게 돈을 빌려줘야하는 상황
  + 각 사업가는 빌리고자하는 금액이 모두 다름
  + 모두 빌리게되면, 은행의 잔액이 마이너스가 되는 상황
+ 해결
  + 은행의 여윳돈과 사업가들에게 빌려준 돈들을 보고 대출 가능한 상황인지 확인하고 빌려줌
+ 단점
  + 즉, 프로세스가 자원을 요청할 때마다 안전상태인지 시뮬레이션 해야하므로 **비용이 많이 든다.**
### 3. 검출 후 회복
+ 교착 상태의 발생을 인정하고 사후에 조치하는 방식
+ 프로세스가 자원을 요구하면 일단 할당하고, 교착 상태가 검출되면 회복시킴
#### 회복 방식
+ 선점을 통한 회복
  + 교착 상태가 해결될 때까지 한 프로세스씩 자원을 몰아주는 방식
+ 프로세스 강제 종료를 통한 회복
  + 교착 상태에 놓인 프로세스 모두 강제 종료하는 방식 -> 작업 내역을 잃을 수 있음!
  + 교착 상태가 해결될 때까지 한 프로세스씩 강제 종료하는 방식 -> 오버헤드 발생 가능!
### 기타: 교착 상태 무시 방법
+ 데드락에 아무런 대비 없이 발생하도록 내버려 두는 방법
+ 교착상태 발생 가능성이 극히 적고, 교착 상태 해결 비용이 많이 들어갈 경우 사용
#### 타조 알고리즘 (Ostrich Algorithm)
> 대부분의 운영체제에서 해당 알고리즘을 사용하여 해결한다.
+ 데드락이 발생하면, 시스템을 재시작하거나 특정 스레드를 강제 종료하는 방법으로 해결